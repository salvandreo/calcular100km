<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estratega 100km - 24h</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; }
        body { font-family: system-ui, sans-serif; padding: 15px; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin: 0 0 15px 0; color: var(--primary); font-size: 1.2rem; text-align: center; }
        label { font-weight: bold; font-size: 0.9rem; color: #64748b; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .res-box { display: none; border-top: 5px solid var(--primary); }
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }
        .metric-card { background: #f1f5f9; padding: 12px; border-radius: 10px; text-align: center; }
        .val { display: block; font-size: 1.1rem; font-weight: 800; color: #0f172a; }
        .next-step { background: #f0fdf4; border: 1px solid var(--success); padding: 15px; border-radius: 12px; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

    <div class="card">
        <h2>⏱️ Control de Carrera (24h)</h2>
        
        <label>¿En qué punto estás?</label>
        <select id="avi">
            <option value="1">Campos de golf (Km 13)</option>
            <option value="2">Camino la mina (Km 23)</option>
            <option value="3">Calle Algorfa COMIDA (Km 32)</option>
            <option value="4">El canal - Los quiles (Km 39)</option>
            <option value="5">Colegio el altet (Km 47)</option>
            <option value="6">Angelets (Km 58)</option>
            <option value="7">Calle Algorfa CENA (Km 66)</option>
            <option value="8">Niño del tambor (Km 73)</option>
            <option value="9">El rocío (Km 78)</option>
            <option value="10">Balsa Conseller (Km 82.5)</option>
            <option value="11">Castro (Km 92)</option>
        </select>

        <label>Hora de llegada:</label>
        <input type="time" id="horaLlegada">

        <button onclick="calcular()">CALCULAR ESTADO</button>
    </div>

    <div id="resultado" class="card res-box">
        <div class="metric-grid">
            <div class="metric-card"><span>Ritmo Medio</span><span id="vRitmo" class="val">-</span></div>
            <div class="metric-card"><span>Velocidad</span><span id="vVel" class="val">-</span></div>
            <div class="metric-card"><span>Colchón Corte</span><span id="vMargen" class="val">-</span></div>
            <div class="metric-card"><span>Distancia Acum.</span><span id="vDist" class="val">-</span></div>
        </div>
        <div id="vSiguiente" class="next-step"></div>
    </div>

<script>
    // Datos exactos de tu tabla
    const DATOS = [
        { n: "Salida", km: 0, corte: "08:00", tSiguiente: 180 },
        { n: "Campos de golf", km: 13, corte: "11:00", tSiguiente: 120 },
        { n: "Camino la mina", km: 23, corte: "13:00", tSiguiente: 140 },
        { n: "Calle Algorfa COMIDA", km: 32, corte: "15:20", tSiguiente: 160 },
        { n: "El canal - Los quiles", km: 39, corte: "18:00", tSiguiente: 50 },
        { n: "Colegio el altet", km: 47, corte: "18:50", tSiguiente: 170 },
        { n: "Angelets", km: 58, corte: "21:40", tSiguiente: 100 },
        { n: "Calle Algorfa CENA", km: 66, corte: "23:20", tSiguiente: 100 }, // Estimado para Niño
        { n: "Niño del tambor", km: 73, corte: "01:00", tSiguiente: 70 }, 
        { n: "El rocío", km: 78, corte: "02:10", tSiguiente: 110 },
        { n: "Balsa Conseller", km: 82.5, corte: "04:00", tSiguiente: 90 },
        { n: "Castro", km: 92, corte: "05:30", tSiguiente: 150 }
    ];

    const INICIO = "08:00";

    function formatRitmo(decimal) {
        if (!decimal || decimal === Infinity) return "00:00";
        const totalSeg = Math.round(decimal * 60);
        const mm = Math.floor(totalSeg / 60);
        const ss = totalSeg % 60;
        return `${mm.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')} min/km`;
    }

    function aFecha(hStr) {
        const [h, m] = hStr.split(':').map(Number);
        const dia = (h < 8) ? 2 : 1; // Si es antes de las 8am, es el día 2
        return new Date(2026, 0, dia, h, m);
    }

    function calcular() {
        const i = parseInt(document.getElementById('avi').value);
        const hLlegadaStr = document.getElementById('horaLlegada').value;
        if (!hLlegadaStr) return;

        const actual = DATOS[i];
        const fInicio = aFecha(INICIO);
        const fLlegada = aFecha(hLlegadaStr);
        const fCorte = aFecha(actual.corte);

        // 1. Cálculos ACUMULADOS (Desde km 0)
        const distAcum = actual.km;
        let tiempoTotalMs = fLlegada - fInicio;
        if (tiempoTotalMs < 0) tiempoTotalMs += 24 * 60 * 60 * 1000;
        
        const tiempoTotalMin = tiempoTotalMs / 60000;
        const ritmoMedio = tiempoTotalMin / distAcum;
        const velMedia = 60 / ritmoMedio;

        // 2. Margen de corte
        const margenMin = Math.floor((fCorte - fLlegada) / 60000);

        // 3. Resultado
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('vRitmo').innerText = formatRitmo(ritmoMedio);
        document.getElementById('vVel').innerText = velMedia.toFixed(1) + " km/h";
        document.getElementById('vDist').innerText = distAcum + " km";
        
        const vMargen = document.getElementById('vMargen');
        vMargen.innerText = (margenMin >= 0 ? "+" : "") + margenMin + " min";
        vMargen.style.color = margenMin < 10 ? "var(--danger)" : "var(--success)";

        document.getElementById('vSiguiente').innerHTML = `
            <strong>ESTADO DEL COLCHÓN:</strong><br>
            Tienes <b>${actual.tSiguiente + margenMin} min</b> para llegar al próximo punto.<br>
            <small>(Tiempo base tramo + tu adelanto actual)</small>
        `;
    }
</script>
</body>
</html>
