<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estratega 100km V2</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; }
        body { font-family: system-ui, sans-serif; padding: 15px; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin: 0 0 15px 0; color: var(--primary); font-size: 1.2rem; text-align: center; }
        label { font-weight: bold; font-size: 0.9rem; color: #64748b; }
        select, input { width: 100%; padding: 14px; margin: 8px 0 18px 0; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .res-box { display: none; border-top: 5px solid var(--primary); animation: fadeIn 0.3s; }
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }
        .metric-card { background: #f1f5f9; padding: 12px; border-radius: 10px; text-align: center; }
        .val { display: block; font-size: 1.2rem; font-weight: 800; color: #0f172a; }
        .next-step { background: #f0fdf4; border: 1px solid var(--success); padding: 15px; border-radius: 12px; margin-top: 10px; text-align: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>⏱️ Control de Carrera</h2>
        <label>Punto donde te encuentras:</label>
        <select id="avi">
            <option value="1">Campos de golf (Km 13)</option>
            <option value="2">Camino la mina (Km 23)</option>
            <option value="3">Calle Algorfa COMIDA (Km 32)</option>
            <option value="4">El canal - Los quiles (Km 39)</option>
            <option value="5">Colegio el altet (Km 47)</option>
            <option value="6">Angelets (Km 58)</option>
            <option value="7">Calle Algorfa CENA (Km 66)</option>
            <option value="8">Niño del tambor (Km 73)</option>
            <option value="9">El rocío (Km 78)</option>
            <option value="10">Balsa Conseller (Km 82.5)</option>
            <option value="11">Castro (Km 92)</option>
        </select>

        <label>Hora de llegada real:</label>
        <input type="time" id="horaLlegada">

        <button onclick="calcular()">CALCULAR DATOS</button>
    </div>

    <div id="resultado" class="card res-box">
        <div class="metric-grid">
            <div class="metric-card"><span>Ritmo Tramo</span><span id="vRitmo" class="val">-</span></div>
            <div class="metric-card"><span>Velocidad</span><span id="vVel" class="val">-</span></div>
            <div class="metric-card"><span>Colchón Corte</span><span id="vMargen" class="val" style="color:var(--success)">-</span></div>
            <div class="metric-card"><span>Distancia</span><span id="vDist" class="val">-</span></div>
        </div>
        <div class="next-step" id="vSiguiente"></div>
    </div>

<script>
    const DATOS = [
        { n: "Salida", km: 0, corte: "08:00", tBaseSig: 180 },
        { n: "Campos de golf", km: 13, corte: "11:00", tBaseSig: 120 },
        { n: "Camino la mina", km: 23, corte: "13:00", tBaseSig: 140 },
        { n: "Calle Algorfa COMIDA", km: 32, corte: "15:20", tBaseSig: 160 },
        { n: "El canal - Los quiles", km: 39, corte: "18:00", tBaseSig: 50 },
        { n: "Colegio el altet", km: 47, corte: "18:50", tBaseSig: 170 },
        { n: "Angelets", km: 58, corte: "21:40", tBaseSig: 100 },
        { n: "Calle Algorfa CENA", km: 66, corte: "23:20", tBaseSig: 100 },
        { n: "Niño del tambor", km: 73, corte: "01:00", tBaseSig: 70 },
        { n: "El rocío", km: 78, corte: "02:10", tBaseSig: 110 },
        { n: "Balsa Conseller", km: 82.5, corte: "04:00", tBaseSig: 90 },
        { n: "Castro", km: 92, corte: "05:30", tBaseSig: 180 }
    ];

    let ultimaHoraReferencia = new Date(2026, 0, 1, 8, 0);
    let ultimoKmReferencia = 0;

    function formatRitmo(decimalMinutos) {
        if (decimalMinutos === Infinity || isNaN(decimalMinutos)) return "00:00";
        const mins = Math.floor(Math.abs(decimalMinutos));
        const segs = Math.round((Math.abs(decimalMinutos) - mins) * 60);
        return `${mins.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')} min/km`;
    }

    function calcular() {
        const i = parseInt(document.getElementById('avi').value);
        const horaInput = document.getElementById('horaLlegada').value;
        if(!horaInput) return;

        const [h, m] = horaInput.split(':').map(Number);
        // Lógica de día: Si la hora es < 8 am, asumimos que es el segundo día (post-medianoche)
        let fechaLlegada = new Date(2026, 0, (h < 8 ? 2 : 1), h, m);
        
        const actual = DATOS[i];

        // 1. Margen (Siempre positivo si vas antes del corte)
        const [ch, cm] = actual.corte.split(':').map(Number);
        let fechaCorte = new Date(2026, 0, (ch < 8 ? 2 : 1), ch, cm);
        const margenMinutos = Math.floor((fechaCorte - fechaLlegada) / 60000);

        // 2. Cálculos de tramo (Usamos Math.abs para asegurar positividad)
        const distTramo = Math.abs(actual.km - ultimoKmReferencia);
        const tiempoTramoMin = Math.abs((fechaLlegada - ultimaHoraReferencia) / 60000);
        
        const ritmoDecimal = tiempoTramoMin / distTramo;
        const velocidad = 60 / ritmoDecimal;

        // 3. Resultado Siguiente
        const tiempoTotalAlSig = actual.tBaseSig + margenMinutos;

        // Renderizar
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('vRitmo').innerText = formatRitmo(ritmoDecimal);
        document.getElementById('vVel').innerText = Math.abs(velocidad).toFixed(1) + " km/h";
        document.getElementById('vMargen').innerText = (margenMinutos >= 0 ? "+" : "") + margenMinutos + " min";
        document.getElementById('vDist').innerText = distTramo.toFixed(1) + " km";
        
        document.getElementById('vSiguiente').innerHTML = `
            <strong>SIGUIENTE TRAMO:</strong><br>
            Dispones de <b style="font-size:1.4rem; color:var(--success)">${tiempoTotalAlSig} min</b><br>
            para llegar al próximo avituallamiento.
        `;

        // Actualizar referencia para el próximo punto
        if(confirm("¿Confirmar registro? (Esto iniciará el cronómetro para el siguiente tramo)")) {
            ultimaHoraReferencia = fechaLlegada;
            ultimoKmReferencia = actual.km;
        }
    }
</script>
</body>
</html>