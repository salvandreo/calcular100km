<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estratega 100km V8</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; }
        body { font-family: system-ui, sans-serif; padding: 10px; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; border: 1px solid #e2e8f0; }
        h2 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.1rem; text-align: center; }
        label { font-weight: bold; font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .res-box { display: none; border-top: 4px solid var(--primary); margin-top: 10px; }
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .metric-card { background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center; }
        .val { display: block; font-size: 1rem; font-weight: 800; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        th { background: #f1f5f9; padding: 8px; border-bottom: 2px solid #e2e8f0; text-align: center; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
    </style>
</head>
<body>

    <div class="card">
        <h2>‚è±Ô∏è Registro de Paso</h2>
        <label>Punto:</label>
        <select id="avi">
            <option value="1">Campos de golf (Km 13)</option>
            <option value="2">Camino la mina (Km 23)</option>
            <option value="3">Calle Algorfa COMIDA (Km 32)</option>
            <option value="4">El canal - Los quiles (Km 39)</option>
            <option value="5">Colegio el altet (Km 47)</option>
            <option value="6">Angelets (Km 58)</option>
            <option value="7">Calle Algorfa CENA (Km 66)</option>
            <option value="8">Ni√±o del tambor (Km 73)</option>
            <option value="9">El roc√≠o (Km 78)</option>
            <option value="10">Balsa Conseller (Km 82.5)</option>
            <option value="11">Castro (Km 92)</option>
        </select>
        <input type="time" id="horaLlegada">
        <button onclick="registrar()">CALCULAR Y GUARDAR</button>
    </div>

    <div id="resultado" class="card res-box">
        <div class="metric-grid">
            <div class="metric-card"><span>Ritmo Tramo</span><span id="vRitmo" class="val">-</span></div>
            <div class="metric-card"><span>Vel. Tramo</span><span id="vVel" class="val">-</span></div>
        </div>
        <div id="vColchon" style="text-align:center; padding:10px; font-weight:bold; border-radius:8px;"></div>
    </div>

    <div class="card" id="cardHistorial" style="display:none;">
        <h2>üìú Historial de Tramos</h2>
        <table id="tabla">
            <thead>
                <tr><th>KM</th><th>Ritmo</th><th>Vel.</th><th>Colch√≥n</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    const DATOS = [
        { km: 0, corte: "08:00" },
        { km: 13, corte: "11:00" }, { km: 23, corte: "13:00" }, { km: 32, corte: "15:20" },
        { km: 39, corte: "18:00" }, { km: 47, corte: "18:50" }, { km: 58, corte: "21:40" },
        { km: 66, corte: "23:20" }, { km: 73, corte: "01:00" }, { km: 78, corte: "02:10" },
        { km: 82.5, corte: "04:00" }, { km: 92, corte: "05:30" }
    ];

    let historialHoras = { 0: "08:00" };

    function registrar() {
        const i = document.getElementById('avi').value;
        const h = document.getElementById('horaLlegada').value;
        if(!h) return;

        historialHoras[i] = h;
        const actual = DATOS[i];
        
        let antIdx = i - 1;
        while(antIdx >= 0 && !historialHoras[antIdx]) antIdx--;
        
        const fLlegada = parseH(h);
        const fSalidaAnterior = parseH(historialHoras[antIdx]);
        const fCorte = parseH(actual.corte);

        const distTramo = actual.km - DATOS[antIdx].km;
        let tiempoMin = (fLlegada - fSalidaAnterior) / 60000;
        if(tiempoMin < 0) tiempoMin += 1440;

        const ritmoDecimal = tiempoMin / distTramo;
        const velocidad = 60 / ritmoDecimal;
        const colchon = Math.floor((fCorte - fLlegada) / 60000);

        document.getElementById('resultado').style.display = 'block';
        document.getElementById('cardHistorial').style.display = 'block';
        document.getElementById('vRitmo').innerText = fmtR(ritmoDecimal);
        document.getElementById('vVel').innerText = velocidad.toFixed(1) + " km/h";
        
        const divC = document.getElementById('vColchon');
        divC.innerText = "COLCH√ìN ACTUAL: " + colchon + " MIN";
        divC.style.background = colchon < 10 ? "#fee2e2" : "#dcfce7";
        divC.style.color = colchon < 10 ? "red" : "green";

        actualizarTabla(actual.km, ritmoDecimal, velocidad, colchon);
    }

    function parseH(s) {
        const [h, m] = s.split(':').map(Number);
        return new Date(2026, 0, (h < 8 ? 2 : 1), h, m);
    }

    function fmtR(d) {
        const m = Math.floor(d), s = Math.round((d - m) * 60);
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} min/km`;
    }

    function actualizarTabla(km, r, v, c) {
        const tbody = document.querySelector("#tabla tbody");
        
        // CORRECCI√ìN: Buscamos la fila por una ID de atributo para que sea exacta
        let filaExistente = tbody.querySelector(`tr[data-km="${km}"]`);
        if (filaExistente) {
            filaExistente.remove();
        }

        const row = tbody.insertRow();
        row.setAttribute('data-km', km); // Marcamos la fila con el KM exacto
        row.innerHTML = `
            <td><b>${km}k</b></td>
            <td>${fmtR(r).replace(' min/km','')}</td>
            <td>${v.toFixed(1)}</td>
            <td style="color:${c < 10 ? 'red' : 'green'}"><b>${c} min</b></td>
        `;

        // Re-ordenar la tabla siempre por KM
        Array.from(tbody.querySelectorAll("tr"))
            .sort((a, b) => parseFloat(a.getAttribute('data-km')) - parseFloat(b.getAttribute('data-km')))
            .forEach(tr => tbody.appendChild(tr));
    }
</script>
</body>
</html>
