<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estratega 100km V10</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f8fafc; --card-bg: white; --text: #1e293b; }
        body.dark-mode { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --primary: #3b82f6; }
        
        body { font-family: system-ui, sans-serif; padding: 10px; background: var(--bg); color: var(--text); transition: 0.3s; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; border: 1px solid #e2e8f0; }
        
        .progress-container { width: 100%; background: #e2e8f0; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--success); transition: 0.5s; }

        h2 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.1rem; text-align: center; }
        label { font-weight: bold; font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
        button { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        
        .res-box { display: none; border-top: 4px solid var(--primary); margin-top: 10px; }
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .metric-card { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; text-align: center; }
        .val { display: block; font-size: 1rem; font-weight: 800; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        th { background: rgba(0,0,0,0.05); padding: 8px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: center; }
        
        .target-box { background: #f0fdf4; color: #16a34a; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 5px; border: 1px solid #bbf7d0; line-height: 1.4; }
        body.dark-mode .target-box { background: #064e3b; color: #4ade80; border-color: #065f46; }
    </style>
</head>
<body onload="checkNightMode()">

    <div class="card">
        <h2>üèÅ Progreso: <span id="txtProgreso">0%</span></h2>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div class="card">
        <h2>‚è±Ô∏è Registro de Paso</h2>
        <label>Punto:</label>
        <select id="avi">
            <option value="1">Campos de golf (Km 13)</option>
            <option value="2">Camino la mina (Km 23)</option>
            <option value="3">Calle Algorfa COMIDA (Km 32)</option>
            <option value="4">El canal - Los quiles (Km 39)</option>
            <option value="5">Colegio el altet (Km 47)</option>
            <option value="6">Angelets (Km 58)</option>
            <option value="7">Calle Algorfa CENA (Km 66)</option>
            <option value="8">Ni√±o del tambor (Km 73)</option>
            <option value="9">El roc√≠o (Km 78)</option>
            <option value="10">Balsa Conseller (Km 82.5)</option>
            <option value="11">Castro (Km 92)</option>
        </select>
        <input type="time" id="horaLlegada">
        <button onclick="registrar()">CALCULAR Y GUARDAR</button>
    </div>

    <div id="resultado" class="card res-box">
        <div class="metric-grid">
            <div class="metric-card"><span>Ritmo Tramo</span><span id="vRitmo" class="val">-</span></div>
            <div class="metric-card"><span>Vel. Tramo</span><span id="vVel" class="val">-</span></div>
        </div>
        <div id="vColchon" style="text-align:center; padding:10px; font-weight:bold; border-radius:8px; margin-bottom:8px;"></div>
        <div id="vTarget" class="target-box"></div>
    </div>

    <div class="card" id="cardHistorial" style="display:none;">
        <h2>üìú Historial de Tramos</h2>
        <table id="tabla">
            <thead><tr><th>KM</th><th>Ritmo</th><th>Vel.</th><th>Colch√≥n</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    const DATOS = [
        { km: 0, corte: "08:00" },
        { km: 13, corte: "11:00" }, { km: 23, corte: "13:00" }, { km: 32, corte: "15:20" },
        { km: 39, corte: "18:00" }, { km: 47, corte: "18:50" }, { km: 58, corte: "21:40" },
        { km: 66, corte: "23:20" }, { km: 73, corte: "01:00" }, { km: 78, corte: "02:10" },
        { km: 82.5, corte: "04:00" }, { km: 92, corte: "05:30" }
    ];

    let historialHoras = { 0: "08:00" };

    function checkNightMode() {
        const h = new Date().getHours();
        if (h >= 19 || h < 7) document.body.classList.add('dark-mode');
    }

    function registrar() {
        const i = parseInt(document.getElementById('avi').value);
        const h = document.getElementById('horaLlegada').value;
        if(!h) return;

        historialHoras[i] = h;
        const actual = DATOS[i];
        let antIdx = i - 1;
        while(antIdx >= 0 && !historialHoras[antIdx]) antIdx--;
        
        const fLlegada = parseH(h);
        const fSalidaAnt = parseH(historialHoras[antIdx]);
        const fCorte = parseH(actual.corte);

        const distTramo = actual.km - DATOS[antIdx].km;
        let tMin = (fLlegada - fSalidaAnt) / 60000;
        if(tMin < 0) tMin += 1440;

        const ritmo = tMin / distTramo;
        const vel = 60 / ritmo;
        const colchon = Math.floor((fCorte - fLlegada) / 60000);

        // UI Principal
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('cardHistorial').style.display = 'block';
        document.getElementById('vRitmo').innerText = fmtR(ritmo);
        document.getElementById('vVel').innerText = vel.toFixed(1) + " km/h";
        
        const divC = document.getElementById('vColchon');
        divC.innerText = "COLCH√ìN: " + colchon + " MIN";
        divC.style.background = colchon < 15 ? "var(--danger)" : "var(--success)";
        divC.style.color = "white";

        // C√ÅLCULO DE RITMO OBJETIVO (CORREGIDO)
        if (i < DATOS.length - 1) {
            const sig = DATOS[i+1];
            const distSig = sig.km - actual.km;
            const fCorteSig = parseH(sig.corte);
            
            // Tiempo disponible real para el siguiente punto
            let tDispTotal = (fCorteSig - fLlegada) / 60000;
            if(tDispTotal < 0) tDispTotal += 1440;

            // Para no ir al l√≠mite, calculamos el ritmo para llegar con 10 min de margen extra
            let tSeguro = tDispTotal - 10;
            if(tSeguro <= 0) tSeguro = tDispTotal; // Si ya no hay margen, usamos el total

            const rObjetivo = tSeguro / distSig;
            
            document.getElementById('vTarget').innerHTML = `
                PR√ìXIMO TRAMO (${distSig}km):<br>
                <span style="font-size:0.85rem; opacity:0.8">Ritmo para ganar 10' de margen:</span><br>
                <span style="font-size:1.3rem">${fmtR(rObjetivo)}</span>
            `;
        } else {
            document.getElementById('vTarget').innerHTML = "üèÅ ¬°√öltimo tramo! ¬°A por la meta!";
        }

        // Barra Progreso
        const porc = Math.round((actual.km / 100) * 100);
        document.getElementById('progressBar').style.width = porc + "%";
        document.getElementById('txtProgreso').innerText = porc + "%";

        actualizarTabla(actual.km, ritmo, vel, colchon);
    }

    function parseH(s) {
        const [h, m] = s.split(':').map(Number);
        return new Date(2026, 0, (h < 8 ? 2 : 1), h, m);
    }

    function fmtR(d) {
        const m = Math.floor(d), s = Math.round((d - m) * 60);
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} min/km`;
    }

    function actualizarTabla(km, r, v, c) {
        const tbody = document.querySelector("#tabla tbody");
        // Borra si ya existe para evitar duplicados al corregir
        let fila = tbody.querySelector(`tr[data-km="${km}"]`);
        if (fila) fila.remove();

        const row = tbody.insertRow();
        row.setAttribute('data-km', km);
        row.innerHTML = `
            <td><b>${km}k</b></td>
            <td>${fmtR(r).replace(' min/km','')}</td>
            <td>${v.toFixed(1)}</td>
            <td style="color:${c < 15 ? 'red' : 'green'}"><b>${c}'</b></td>
        `;
        // Ordenar por KM
        Array.from(tbody.querySelectorAll("tr"))
            .sort((a, b) => parseFloat(a.getAttribute('data-km')) - parseFloat(b.getAttribute('data-km')))
            .forEach(tr => tbody.appendChild(tr));
    }
</script>
</body>
</html>
